<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Top 1000 PC Games | Free Download</title>

    <!-- Default SEO Meta Tags -->
    <meta name="description" content="Find and download the best 1000 PC games. Get trending RPGs, battle royale, and strategy games.">
    <meta name="keywords" content="best PC games, free game download, RPG games, strategy games, battle royale, FPS games">
    <meta name="author" content="1337Xtreme">
    <meta name="robots" content="index, follow">

    <!-- Load API Key -->
    <script src="games.js"></script>

    <!-- Schema Markup Placeholder -->
    <script type="application/ld+json" id="schema-data"></script>

</head>
<body>

    <h1>Top 1000 PC Games</h1>

    <table class="game-table">
        <thead>
            <tr>
                <th>#</th>
                <th>Game Name</th>
            </tr>
        </thead>
        <tbody id="game-list"></tbody>
    </table>

    <div class="pagination" id="pagination"></div>

    <script>
        let urlParams = new URLSearchParams(window.location.search);
        let currentPage = parseInt(urlParams.get("page")) || 1;
        const gamesPerPage = 50;
        let allGames = new Map(); // Use a Map to prevent duplicate games
        let isLoading = false;

        async function fetchGames(pageNumber = 1) {
            let apiUrl = `https://api.rawg.io/api/games?key=${config.API_KEY}&page_size=50&page=${pageNumber}&platforms=4`;

            try {
                let response = await fetch(apiUrl);
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                let data = await response.json();
                if (!data.results) throw new Error("No game data found.");

                return data.results.map((game, index) => ({
                    position: (pageNumber - 1) * 50 + index + 1,
                    name: game.name,
                    url: "", // URLs will be fetched later
                    id: game.id
                }));
            } catch (error) {
                console.error("‚ùå Game Fetch Error:", error);
                return [];
            }
        }

        async function fetchAllGames() {
            if (isLoading) return;
            isLoading = true;
            document.getElementById("game-list").innerHTML = "<tr><td colspan='2'>Loading games...</td></tr>";

            if (typeof config === "undefined" || !config.API_KEY) {
                console.error("‚ùå API key is missing or games.js is not loaded.");
                return;
            }

            for (let i = 1; i <= 20; i++) {
                let moreGames = await fetchGames(i);
                moreGames.forEach(game => allGames.set(game.id, game)); // Store unique games using their ID
                displayGames();
                createPagination();
                console.log(`‚úÖ Loaded ${allGames.size} unique games so far`);
            }

            isLoading = false;
            injectSchemaMarkup();
            fetchGameStoreUrls();
        }

        async function fetchGameStoreUrls() {
            console.log("üîÑ Fetching store URLs...");
            let gameBatches = Array.from(allGames.values()).map(game => getGameStoreUrl(game.id, game.name));
            let urls = await Promise.all(gameBatches);

            let index = 0;
            allGames.forEach(game => {
                game.url = urls[index++]; // ‚úÖ Update game URLs
            });

            console.log("‚úÖ Store URLs Loaded!");
            displayGames();
            injectSchemaMarkup();
        }

        async function getGameStoreUrl(gameId, gameName) {
            let gameDetailsUrl = `https://api.rawg.io/api/games/${gameId}?key=${config.API_KEY}`;
            try {
                let response = await fetch(gameDetailsUrl);
                if (!response.ok) throw new Error(`Error fetching game details: ${response.status}`);
                let gameData = await response.json();

                if (gameData.stores && gameData.stores.length > 0) {
                    return gameData.stores[0].url; // ‚úÖ Link to store (Steam, Epic, etc.)
                } else {
                    return `https://rawg.io/games/${gameId}`; // ‚úÖ Link to RAWG game page instead of IGN
                }
            } catch (error) {
                console.error(`Error fetching store URL for game ID ${gameId}:`, error);
                return `https://rawg.io/games/${gameId}`;
            }
        }

        function displayGames() {
            let start = (currentPage - 1) * gamesPerPage;
            let end = start + gamesPerPage;
            let paginatedGames = Array.from(allGames.values()).slice(start, end);

            document.getElementById("game-list").innerHTML = paginatedGames.map(game =>
                `<tr><td>${game.position}</td><td><a href="${game.url}" target="_blank">${game.name}</a></td></tr>`
            ).join("");

            updateMetaTags(paginatedGames);
        }

        function createPagination() {
            let totalPages = Math.ceil(allGames.size / gamesPerPage);
            document.getElementById("pagination").innerHTML =
                Array.from({ length: totalPages }, (_, i) => `<a href="?page=${i + 1}">${i + 1}</a>`).join(" | ");
        }

        function updateMetaTags(games) {
            if (games.length === 0) return;

            let firstGameName = games[0].name;
            let pageTitle = `${firstGameName} Free Download | Top PC Games`;
            document.title = pageTitle;

            let metaDescription = `Download ${firstGameName} for free! Explore the best trending PC games available now.`;
            let metaKeywords = games.map(game => game.name + " free download").join(", ");

            document.querySelector("meta[name='description']").setAttribute("content", metaDescription);
            document.querySelector("meta[name='keywords']").setAttribute("content", metaKeywords);

            console.log("‚úÖ Meta tags updated:", { title: pageTitle, description: metaDescription, keywords: metaKeywords });
        }

        function injectSchemaMarkup() {
            let schemaData = {
                "@context": "https://schema.org",
                "@type": "ItemList",
                "name": "Top 1000 PC Games",
                "itemListElement": Array.from(allGames.values()).map((game, index) => ({
                    "@type": "ListItem",
                    "position": index + 1,
                    "name": game.name,
                    "url": game.url
                })).filter(game => game.url) // ‚úÖ Removes invalid URLs
            };

            let schemaScript = document.createElement("script");
            schemaScript.type = "application/ld+json";
            schemaScript.textContent = JSON.stringify(schemaData, null, 2);

            let schemaContainer = document.getElementById("schema-data");
            if (schemaContainer) {
                schemaContainer.remove();
            }

            document.head.appendChild(schemaScript);

            console.log("‚úÖ Schema Injected:", schemaData);
        }

        fetchAllGames();
    </script>

</body>
</html>